let game={maxXY:400,waitingDraw:!1,canDraw:!1,valid:!1,lineWidth:5,oob:[0,1,2,3,6,7,8,9,10,11,18,19,20,29,30,39,60,69,70,79,80,81,88,89,90,91,92,93,96,97,98,99],offset:{3:[5,0],6:[5,0],12:[-5,0],17:[-5,0],21:[-5,-5],28:[-5,5],30:[0,5],39:[0,-5],60:[0,5],69:[0,-5],71:[5,-5],78:[5,5],82:[5,0],87:[5,0],93:[-5,0],96:[-5,0]},colors:["ff0000","00ff00","0000ff","ffff00"],levels:[[["2187","7166","2382"],["2187","0566","0328"],["1259","5278","6057"],["2460","0657","1274"],["1269","2687","2157"],["4036","3378","1274"],["2193","2460","4057"],["2124","2872","0547"],["4294","1744","4671"],["0565","3482","4660"],["4795","4578","2582"],["0577","4382","3660"],["3795","1578","3371"],["1560","4782","2853"],],[["0454","4078","2135","2876"],["2125","0647","2873","6075"],["2146","1764","2594","3378"],["1244","2833","4294","4660"],["3073","0565","3693","3459"],["0334","2659","4296","6671"],["2176","0432","4694","2359"],["1734","1369","5295","6671"],["2682","3378","4830"],["7660","2682","0662"],["2682","1763","3073"],["5066","2596","1277"],["3282","2696","5059"],["3750","5387","1266"],],[["3056","0537","3593","2852"],["0575","4249","2595","4047"],["4387","1256","3693","1763"],["0474","1776","5471","8226"],["2582","1378","5962","3295"],["3750","0469","0265","5396"],["6882","3787","3062","2371"],["2682","3478","2173","5296"],],],done:[],paths:[],levelCompleted:[],currentLevel:"00",currentTarget:"",startX:0,startY:0};!function(e){let t=e(".viewport"),l=e(".popup"),n=e("#welcome"),s=e("#game_menu"),$=e("#game_wrapper"),o=e("#game"),m=e("#path"),_=e("#level_name"),h=e("#settings"),p=o[0].getContext("2d"),f=m[0].getContext("2d"),v=e("#check")[0].getContext("2d"),u=0,w=0,C=[],x=document.getElementById("game"),T=()=>{let e={levelCompleted:game.levelCompleted};localStorage.setItem("twodots",JSON.stringify(e))},Y=()=>{if(f.fillStyle="white",p.clearRect(0,0,o[0].width,o[0].height),f.fillRect(0,0,o[0].width,o[0].height),p.strokeStyle="#000",S(),game.paths.length)for(i in p.lineWidth=game.lineWidth,game.paths)p.strokeStyle=game.paths[i].color,p.stroke(game.paths[i].path);[a,b]=game.currentLevel.split("");let e=game.levels[a][b];for(i in e)[a,b,c,d]=e[i].toString().split(""),k(a,b,c,d,i),k(c,d,a,b,i)},X=()=>{game.paths=[],game.done=[],game.paths=[],game.currentTarget="",Y()},k=(e,t,l,n,s)=>{let $=game.maxXY/10,o=$/2,m=game.offset[e+""+t],_=t*$+o,h=e*$+o;m&&(h+=m[0],_+=m[1]);let v=new Path2D;p.beginPath(),v.arc(h,_,o,0,2*Math.PI),f.fillStyle=p.fillStyle="#"+game.colors[s],p.lineWidth=4,p.strokeStyle="#fff",p.fill(v),p.stroke(v),f.fill(v)},S=()=>{let e=new Path2D;p.lineWidth=5,e.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-15,0,2*Math.PI),$.find("img").css({width:game.maxXY-30+"px",height:game.maxXY-30+"px"}),p.stroke(e)},W=(e,t)=>{let l=game.maxXY/10,n=l/2,s=game.offset[e+""+t],$=t*l+n,o=e*l+n;s&&(o+=s[0],$+=s[1]),v.beginPath(),v.arc(o,$,.85*n,0,2*Math.PI),v.fillStyle="#fff",v.fill(),v.fillStyle="rgba(0,0,0,0.2)",v.fill()},D=()=>{let e=!0,t=new Path2D,l=game.lineWidth;v.strokeStyle="rgba(0,0,0,0.2)",v.fillStyle="white",v.fillRect(0,0,o[0].width,o[0].height),t=new Path2D,v.lineWidth=5,t.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-15,0,2*Math.PI),v.stroke(t),[a,b]=game.currentLevel.split("");let n=game.levels[a][b];for(i in n)[a,b,c,d]=n[i].toString().split(""),W(a,b),W(c,d);for(i in t=new Path2D,game.paths)v.lineWidth=game.lineWidth,v.strokeStyle="#fff",v.stroke(game.paths[i].path),v.strokeStyle="rgba(0,0,0,0.2)",v.stroke(game.paths[i].path);for(i in C){let s=C[i].split(",");i>0&&t.lineTo(s[0],s[1]),t.moveTo(s[0],s[1])}v.stroke(t);let $;for(let m=30;m<=game.maxXY-30;m+=l){for(let _=30;_<=game.maxXY-30&&((($=v.getImageData(m,_,1,1).data)[0]>0||$[1]>0||$[2]>0)&&($[0]<200||$[1]<200||$[2]<200)&&(e=!1),e);_+=l);if(!e)break}return e?(y(),!0):(j("TRY AGAIN!"),C=[],Y(),!1)},y=()=>{let e=new Path2D,t=game.maxXY/10;p.lineWidth=game.lineWidth,[a,b]=game.currentLevel.split("");let l=game.levels[a][b][P()].split(""),n=C[0].split(","),s=[];for(let $=0;$<l.length;$++)l[$]*=t;for(i in Math.abs(l[0]-n[0])<=2*t&&Math.abs(l[1]-n[1])<=2*t?(n[0]=l[0]+t/2,n[1]=l[1]+t/2,s[0]=l[2]+t/2,s[1]=l[3]+t/2):(s[0]=l[0]+t/2,s[1]=l[1]+t/2,n[0]=l[2]+t/2,n[1]=l[3]+t/2),e.moveTo(n[0],n[1]),C){let o=C[i].split(",");e.lineTo(o[0],o[1]),e.moveTo(o[0],o[1])}e.lineTo(s[0],s[1]),e.moveTo(s[0],s[1]),[r,g,b]=game.currentTarget.split(","),game.paths.push({color:"#"+B(parseInt(r),parseInt(g),parseInt(b)),path:e}),game.done.push(game.currentTarget),game.currentTarget="",C=[],Y()},I=()=>{if(game.waitingDraw){game.waitingDraw=!1,game.currentTarget="";return}if(game.canDraw){if(game.canDraw=!1,L()&&(j("TRY AGAIN!"),game.valid=!1),!game.valid)return Y(),C=[];D()&&R(),game.valid=!1}},L=()=>{let e=P(),t=game.maxXY/10,l=C[0].split(","),n=C[C.length-1].split(",");switch(game.currentTarget){case"0,255,0":e=1;break;case"0,0,255":e=2;break;case"255,255,0":e=3}return Math.abs(l[0]-n[0])<=t&&Math.abs(l[1]-n[1])<=t},P=()=>{switch(game.currentTarget){case"0,255,0":return 1;case"0,0,255":return 2;case"255,255,0":return 3}return 0},R=()=>{[a,b]=game.currentLevel.split("");let e=game.levels[a][b];game.done.length>=e.length&&(game.levelCompleted.includes(game.currentLevel)||game.levelCompleted.push(game.currentLevel),T(),j("WELL DONE!",!0),setTimeout(()=>{s.removeClass("d-none"),_.addClass("d-none"),$.addClass("d-none"),h.addClass("d-none"),N(game.currentLevel.substring(0,1))},1e3))},A=(e,t)=>{let l=G(e,t),n=l[0]+","+l[1]+","+l[2];game.waitingDraw&&"255,255,255"===n&&(game.waitingDraw=!1,game.canDraw=!0,[r,g,b]=game.currentTarget.split(","),p.strokeStyle="#"+B(parseInt(r),parseInt(g),parseInt(b)),game.startX=u=e,game.startY=w=t),game.canDraw&&(n===game.currentTarget?(game.valid=!0,I()):(p.lineWidth=game.lineWidth,p.beginPath(),p.moveTo(u,w),p.lineTo(e,t),p.stroke(),u=e,w=t,C.push(u+","+w)))},E=(e,t)=>{if(!game.waitingDraw){let l=G(e,t);l[0]+l[1]+l[2]<765&&!game.done.includes(l[0]+","+l[1]+","+l[2])&&(game.waitingDraw=!0,game.currentTarget=l[0]+","+l[1]+","+l[2])}},N=l=>{if(l<0)return!1;console.log(l);let n=["beginner","intermediate","expert"];if(s.html(""),1===l.length){let o=0,m=e('<div class="row lvl-select"></div>');e('<h2><img src="img/'+n[l]+'.png"></h2>').appendTo(s);for(let p=0;p<game.levels[l].length;p++){let f=e('<div class="col-4"></div>');game.levelCompleted.includes(l+""+p)?e('<div class="lvl-node"><a class="completed" data-level="'+l+p+'"><span>'+(p+1)+"</span></a></div>").appendTo(f):o?e('<div class="lvl-node"><a class="disabled" data-level="-1"><span>'+(p+1)+"</span></a></div>").appendTo(f):(o=1,e('<div class="lvl-node"><a class="current '+n[l]+'" data-level="'+l+p+'"><span>'+(p+1)+"</span></a></div>").appendTo(f)),f.appendTo(m)}m.appendTo(s),e('<div class="col-12 text-center pt-5"><a data-level="main"><img class="label-img" src="img/main_menu.png" style="max-height: 60px;"></a></div>').appendTo(s)}else if("main"===l){e('<h2><img class="label-img" src="img/choose.png"></h2>').appendTo(s);for(let v=0;v<game.levels.length;v++)e('<a data-level="'+v+'" class="d-inline-block mb-3"><img src="img/'+n[v]+'.png"></a>').appendTo(s)}else l.length<4&&(game.currentLevel=l,t.addClass("in-game"),s.addClass("d-none"),_.removeClass("d-none"),$.removeClass("d-none"),h.removeClass("d-none"),_.find("h2").html('<img src="img/'+n[l.substring(0,1)]+'.png"><span class="level-number '+n[l.substring(0,1)]+'">'+(parseInt(l.substring(1))+1)+"</span>"),X())},G=(e,t)=>{let l=f.getImageData(e,t,1,1).data;return[l[0],l[1],l[2]]},B=(e,t,l)=>{if(e>255||t>255||l>255)throw"Invalid color component";return("0"+e.toString(16)).slice(-2)+""+("0"+t.toString(16)).slice(-2)+("0"+l.toString(16)).slice(-2)},O=()=>{t.removeClass("in-game"),s.removeClass("d-none"),_.addClass("d-none"),n.addClass("d-none"),$.addClass("d-none"),h.addClass("d-none"),N("main")},j=(e,n=!1)=>{n?l.addClass("success"):(t.addClass("error"),setTimeout(()=>{t.removeClass("error")},500)),l.text(e),l.removeClass("d-none"),setTimeout(()=>{l.removeClass("success"),l.addClass("d-none")},1e3)};s.on("click","a",function(t){N(e(this).data("level").toString())}),n.on("click",".go_main",function(e){O()}),h.on("click",".go_main",function(e){O()}).on("click","#reset",function(e){X()}),$.on("touchstart",function(e){e.target==x&&(e.preventDefault(),E(e.touches[0].clientX-$.offset().left,e.touches[0].clientY-$.offset().top))}).on("touchmove",function(e){e.touches[0].clientX-$.offset().left<0||e.touches[0].clientX>$.width()||e.touches[0].clientY<$.offset().top||e.touches[0].clientY>$.offset().top+$.height()?I():A(e.touches[0].clientX-$.offset().left,e.touches[0].clientY-$.offset().top)}).on("touchend",I).on("mousedown",function(e){e.preventDefault(),E(e.offsetX,e.offsetY)}).on("mousemove",function(e){A(e.offsetX,e.offsetY)}).on("mouseup",I).on("mouseleave",I),e(window).width()<game.maxXY&&(game.maxXY=e(window).width()),$.css({width:game.maxXY+"px",height:game.maxXY+"px"}),f.canvas.height=p.canvas.height=v.canvas.height=game.maxXY,f.canvas.width=p.canvas.width=v.canvas.width=game.maxXY,f.lineCap=p.lineCap=v.lineCap="round",f.lineWidth=p.lineWidth=v.lineWidth=game.lineWidth,(()=>{let e=JSON.parse(localStorage.getItem("twodots"));e&&(game.levelCompleted=e.levelCompleted?e.levelCompleted:[])})(),X()}(jQuery);
