let game={maxXY:350,waitingDraw:!1,canDraw:!1,valid:!1,lineWidth:5,oob:[0,1,2,3,6,7,8,9,10,11,18,19,20,29,30,39,60,69,70,79,80,81,88,89,90,91,92,93,96,97,98,99],offset:{3:[5,0],6:[5,0],12:[-5,0],17:[-5,0],21:[-5,-5],28:[-5,5],30:[0,5],39:[0,-5],60:[0,5],69:[0,-5],71:[5,-5],78:[5,5],82:[5,0],87:[5,0],93:[-5,0],96:[-5,0]},colors:["ff0000","00ff00","0000ff","ffff00"],levels:[[["2187","7166","2382"],["2187","0566","0328"],["1259","5278","6057"],["2460","0657","1274"],["1269","2687","2157"],["4036","3378","1274"],["2193","2460","4057"],["2124","2872","0547"],],[["0454","4078","2135","2876"],["2125","0647","2873","6075"],["2146","1764","2594","3378"],["1244","2833","4294","4660"],["3073","0565","3693","3459"],["0334","2659","4296","6671"],["2176","0432","4694","2359"],["1734","1369","5295","6671"],],[["3056","0537","3593","2852"],["0575","4249","2595","4047"],["4387","1256","3693","1763"],["0474","1776","5471","8226"],],],done:[],paths:[],levelCompleted:[],currentLevel:"00",currentTarget:"",startX:0,startY:0};!function(e){let t=e(".viewport"),l=e(".popup"),n=e("#welcome"),s=e("#game_menu"),o=e("#game_wrapper"),$=e("#game"),m=e("#path"),_=e("#level_name"),h=e("#settings"),f=$[0].getContext("2d"),p=m[0].getContext("2d"),u=e("#check")[0].getContext("2d"),v=0,w=0,C=[],T=document.getElementById("game"),Y=()=>{let e={levelCompleted:game.levelCompleted};localStorage.setItem("twodots",JSON.stringify(e))},x=()=>{if(p.fillStyle="white",f.clearRect(0,0,$[0].width,$[0].height),p.fillRect(0,0,$[0].width,$[0].height),f.strokeStyle="#000",S(),game.paths.length)for(i in f.lineWidth=game.lineWidth,game.paths)f.strokeStyle=game.paths[i].color,f.stroke(game.paths[i].path);[a,b]=game.currentLevel.split("");let e=game.levels[a][b];for(i in e)[a,b,c,d]=e[i].toString().split(""),k(a,b,c,d,i),k(c,d,a,b,i)},X=()=>{game.paths=[],game.done=[],game.paths=[],game.currentTarget="",x()},k=(e,t,l,n,s)=>{let o=game.maxXY/10,$=o/2,m=game.offset[e+""+t],_=t*o+$,h=e*o+$;m&&(h+=m[0],_+=m[1]);let u=new Path2D;f.beginPath(),u.arc(h,_,$,0,2*Math.PI),p.fillStyle=f.fillStyle="#"+game.colors[s],f.lineWidth=2,f.strokeStyle="#fff",f.fill(u),f.stroke(u),p.fill(u)},S=()=>{let e=new Path2D;f.lineWidth=3,e.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-15,0,2*Math.PI),o.find("img").css({width:game.maxXY-30+"px",height:game.maxXY-30+"px"}),f.stroke(e)},D=(e,t)=>{let l=game.maxXY/10,n=l/2,s=game.offset[e+""+t],o=t*l+n,$=e*l+n;s&&($+=s[0],o+=s[1]),u.beginPath(),u.arc($,o,.85*n,0,2*Math.PI),u.fillStyle="#fff",u.fill(),u.fillStyle="rgba(0,0,0,0.2)",u.fill()},W=()=>{let e=!0,t=new Path2D,l=game.lineWidth;u.strokeStyle="rgba(0,0,0,0.2)",u.fillStyle="white",u.fillRect(0,0,$[0].width,$[0].height),t=new Path2D,u.lineWidth=5,t.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-15,0,2*Math.PI),u.stroke(t),[a,b]=game.currentLevel.split("");let n=game.levels[a][b];for(i in n)[a,b,c,d]=n[i].toString().split(""),D(a,b),D(c,d);for(i in t=new Path2D,game.paths)u.lineWidth=game.lineWidth,u.strokeStyle="#fff",u.stroke(game.paths[i].path),u.strokeStyle="rgba(0,0,0,0.2)",u.stroke(game.paths[i].path);for(i in C){let s=C[i].split(",");i>0&&t.lineTo(s[0],s[1]),t.moveTo(s[0],s[1])}u.stroke(t);let o;for(let m=30;m<=game.maxXY-30;m+=l){for(let _=30;_<=game.maxXY-30&&(((o=u.getImageData(m,_,1,1).data)[0]>0||o[1]>0||o[2]>0)&&(o[0]<200||o[1]<200||o[2]<200)&&(e=!1),e);_+=l);if(!e)break}return e?(I(),!0):(F("TRY AGAIN!"),C=[],x(),!1)},I=()=>{let e=new Path2D,t=game.maxXY/10;f.lineWidth=game.lineWidth,[a,b]=game.currentLevel.split("");let l=game.levels[a][b][E()].split(""),n=C[0].split(","),s=[];for(let o=0;o<l.length;o++)l[o]*=t;for(i in Math.abs(l[0]-n[0])<=2*t&&Math.abs(l[1]-n[1])<=2*t?(n[0]=l[0]+t/2,n[1]=l[1]+t/2,s[0]=l[2]+t/2,s[1]=l[3]+t/2):(s[0]=l[0]+t/2,s[1]=l[1]+t/2,n[0]=l[2]+t/2,n[1]=l[3]+t/2),e.moveTo(n[0],n[1]),C){let $=C[i].split(",");e.lineTo($[0],$[1]),e.moveTo($[0],$[1])}e.lineTo(s[0],s[1]),e.moveTo(s[0],s[1]),[r,g,b]=game.currentTarget.split(","),game.paths.push({color:"#"+G(parseInt(r),parseInt(g),parseInt(b)),path:e}),game.done.push(game.currentTarget),game.currentTarget="",C=[],x()},y=()=>{if(game.waitingDraw){game.waitingDraw=!1,game.currentTarget="";return}if(game.canDraw){if(game.canDraw=!1,L()&&(F("TRY AGAIN!"),game.valid=!1),!game.valid)return x(),C=[];W()&&P(),game.valid=!1}},L=()=>{let e=E(),t=game.maxXY/10,l=C[0].split(","),n=C[C.length-1].split(",");switch(game.currentTarget){case"0,255,0":e=1;break;case"0,0,255":e=2;break;case"255,255,0":e=3}return Math.abs(l[0]-n[0])<=t&&Math.abs(l[1]-n[1])<=t},E=()=>{switch(game.currentTarget){case"0,255,0":return 1;case"0,0,255":return 2;case"255,255,0":return 3}return 0},P=()=>{[a,b]=game.currentLevel.split("");let e=game.levels[a][b];game.done.length>=e.length&&(game.levelCompleted.includes(game.currentLevel)||game.levelCompleted.push(game.currentLevel),Y(),F("WELL DONE!",!0),setTimeout(()=>{s.removeClass("d-none"),_.addClass("d-none"),o.addClass("d-none"),h.addClass("d-none"),N(game.currentLevel.substring(0,1))},1e3))},R=(e,t)=>{let l=B(e,t),n=l[0]+","+l[1]+","+l[2];game.waitingDraw&&"255,255,255"===n&&(game.waitingDraw=!1,game.canDraw=!0,[r,g,b]=game.currentTarget.split(","),f.strokeStyle="#"+G(parseInt(r),parseInt(g),parseInt(b)),game.startX=v=e,game.startY=w=t),game.canDraw&&(n===game.currentTarget?(game.valid=!0,y()):(f.lineWidth=game.lineWidth,f.beginPath(),f.moveTo(v,w),f.lineTo(e,t),f.stroke(),v=e,w=t,C.push(v+","+w)))},A=(e,t)=>{if(!game.waitingDraw){let l=B(e,t);l[0]+l[1]+l[2]<765&&!game.done.includes(l[0]+","+l[1]+","+l[2])&&(game.waitingDraw=!0,game.currentTarget=l[0]+","+l[1]+","+l[2])}},N=l=>{if(l<0)return!1;let n=["BEGINNER","INTERMEDIATE","EXPERT"];if(s.html(""),1===l.length){let $=0,m=e('<div class="row lvl-select"></div>');e("<h2>"+n[l]+"</h2>").appendTo(s);for(let f=0;f<game.levels[l].length;f++){let p=e('<div class="col-4"></div>');game.levelCompleted.includes(l+""+f)?e('<div class="lvl-node"><button data-level="'+l+f+'"><span>'+(f+1)+"</span></button></div>").appendTo(p):$?e('<div class="lvl-node"><button class="disabled" data-level="-1"><span>'+(f+1)+"</span></button></div>").appendTo(p):($=1,e('<div class="lvl-node"><button class="current" data-level="'+l+f+'"><span>'+(f+1)+"</span></button></div>").appendTo(p)),p.appendTo(m)}m.appendTo(s),e('<div class="col-12 text-center"><button data-level="main">BACK</button></div>').appendTo(s)}else if(2===l.length)game.currentLevel=l,t.addClass("in-game"),s.addClass("d-none"),_.removeClass("d-none"),o.removeClass("d-none"),h.removeClass("d-none"),_.find("h2").text(n[l.substring(0,1)]+" "+(parseInt(l.substring(1))+1)),X();else{e("<h2>CHOOSE<br>DIFFICULTY</h2>").appendTo(s);for(let u=0;u<game.levels.length;u++)e('<button data-level="'+u+'">'+n[u]+"</button>").appendTo(s)}},B=(e,t)=>{let l=p.getImageData(e,t,1,1).data;return[l[0],l[1],l[2]]},G=(e,t,l)=>{if(e>255||t>255||l>255)throw"Invalid color component";return("0"+e.toString(16)).slice(-2)+""+("0"+t.toString(16)).slice(-2)+("0"+l.toString(16)).slice(-2)},O=()=>{t.removeClass("in-game"),s.removeClass("d-none"),_.addClass("d-none"),n.addClass("d-none"),o.addClass("d-none"),h.addClass("d-none"),N("main")},F=(e,n=!1)=>{n?l.addClass("success"):(t.addClass("error"),setTimeout(()=>{t.removeClass("error")},500)),l.text(e),l.removeClass("d-none"),setTimeout(()=>{l.removeClass("success"),l.addClass("d-none")},1e3)};s.on("click","button",function(t){N(e(this).data("level").toString())}),n.on("click",".go_main",function(e){O()}),h.on("click",".go_main",function(e){O()}).on("click","#reset",function(e){X()}),o.on("touchstart",function(e){e.target==T&&(e.preventDefault(),A(e.touches[0].clientX-o.offset().left,e.touches[0].clientY-o.offset().top))}).on("touchmove",function(e){e.touches[0].clientX-o.offset().left<0||e.touches[0].clientX>o.width()||e.touches[0].clientY<o.offset().top||e.touches[0].clientY>o.offset().top+o.height()?y():R(e.touches[0].clientX-o.offset().left,e.touches[0].clientY-o.offset().top)}).on("touchend",y).on("mousedown",function(e){e.preventDefault(),A(e.offsetX,e.offsetY)}).on("mousemove",function(e){R(e.offsetX,e.offsetY)}).on("mouseup",y).on("mouseleave",y),e(window).width()<game.maxXY&&(game.maxXY=e(window).width()),o.css({width:game.maxXY+"px",height:game.maxXY+"px"}),p.canvas.height=f.canvas.height=u.canvas.height=game.maxXY,p.canvas.width=f.canvas.width=u.canvas.width=game.maxXY,p.lineCap=f.lineCap=u.lineCap="round",p.lineWidth=f.lineWidth=u.lineWidth=game.lineWidth,(()=>{let e=JSON.parse(localStorage.getItem("twodots"));e&&(game.levelCompleted=e.levelCompleted?e.levelCompleted:[])})(),X()}(jQuery);
