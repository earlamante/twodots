let game={maxXY:500,waitingDraw:!1,canDraw:!1,valid:!1,lineWidth:5,oob:[0,1,2,3,6,7,8,9,10,11,18,19,20,29,30,39,60,69,70,79,80,81,88,89,90,91,92,93,96,97,98,99],offset:{"03":[20,0],"06":[20,0],30:[0,20],60:[0,20],"04":[15,0],"05":[15,0],40:[15,0],50:[15,0],93:[-20,0],96:[-20,0],39:[0,-20],69:[0,-20],49:[0,-15],59:[0,-15],94:[-15,0],95:[-15,0]},colors:["ff0000","00ff00","0000ff","ffff00"],levels:[[["2187","7166","2382"],["2187","0566","0328"],["1259","5278","6057"],["2460","0657","1274"],["1269","2687","2157"],["4036","3378","1274"],["2193","2460","4057"],["2124","2872","0547"]],[["0454","4078","2135","2876"],["2125","0647","2873","6075"],["2146","1764","2594","3378"],["1244","2833","4294","4660"],["3073","0565","3693","3459"],["0334","2659","4296","6671"],["2176","0432","4694","2359"],["1734","1369","5295","6671"]],[["3056","0537","3593","2852"],["0575","4249","2595","4047"],["4387","1256","3693","1763"],["0474","1776","5471","8226"]]],done:[],paths:[],levelCompleted:[],currentLevel:"00",currentTarget:"",startX:0,startY:0};!function(n){let l=n("#game_menu"),o=n("#game_wrapper"),s=n("#game"),e=n("#path"),m=n("#settings"),h=s[0].getContext("2d"),f=e[0].getContext("2d"),p=n("#check")[0].getContext("2d"),u=0,v=0,w=[],t=document.getElementById("game");const X=()=>{var e=JSON.parse(localStorage.getItem("twodots"));e&&(game.levelCompleted=e.levelCompleted||[])};var Y=()=>{if(f.fillStyle=h.fillStyle="white",h.fillRect(0,0,s[0].width,s[0].height),f.fillRect(0,0,s[0].width,s[0].height),h.strokeStyle="#000",D(),game.paths.length)for(i in h.lineWidth=game.lineWidth,game.paths)h.strokeStyle=game.paths[i].color,h.stroke(game.paths[i].path);[a,b]=game.currentLevel.split("");let e=game.levels[a][b];for(i in e)[a,b,c,d]=e[i].toString().split(""),C(a,b,c,d,i),C(c,d,a,b,i)};const x=()=>{game.paths=[],game.done=[],game.paths=[],game.currentTarget="",Y()},C=(e,t,a,n,l)=>{var o=game.maxXY/10,i=o/2,g=game.offset[e+""+t];let r=t*o+i,s=e*o+i;g&&(s+=g[0],r+=g[1]);const m=new Path2D;h.beginPath(),m.arc(s,r,i,0,2*Math.PI),f.fillStyle=h.fillStyle="#"+game.colors[l],h.fill(m),f.fill(m)},D=()=>{const e=new Path2D;h.lineWidth=5,e.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-30,0,2*Math.PI),h.stroke(e)};var T=(e,t)=>{var a=game.maxXY/10,n=.7*a,l=a/2,o=game.offset[e+""+t];let i=t*a+l,g=e*a+l;o&&(g+=o[0],i+=o[1]),p.beginPath(),p.arc(g,i,n/2,0,2*Math.PI),p.fillStyle="#000",p.fill()};const S=()=>{const e=new Path2D;for(i in h.lineWidth=game.lineWidth,w){var t=w[i].split(",");0<i&&e.lineTo(t[0],t[1]),e.moveTo(t[0],t[1])}[r,g,b]=game.currentTarget.split(","),game.paths.push({color:"#"+L(parseInt(r),parseInt(g),parseInt(b)),path:e}),game.done.push(game.currentTarget),game.currentTarget="",w=[],Y()};var I=()=>{if(console.log("stopping"),game.waitingDraw)return game.waitingDraw=!1,void(game.currentTarget="");if(game.canDraw){if(console.log("stopped"),game.canDraw=!1,!game.valid)return Y(),w=[];(()=>{console.log("checking");let n=!0,e=new Path2D,l=game.lineWidth;for(i in p.strokeStyle="rgba(0,0,0,0.2)",p.fillStyle="white",p.fillRect(0,0,s[0].width,s[0].height),game.paths)p.lineWidth=game.lineWidth,p.stroke(game.paths[i].path);for(i in w){var t=w[i].split(",");0<i&&e.lineTo(t[0],t[1]),e.moveTo(t[0],t[1])}if(p.stroke(e),e=new Path2D,p.lineWidth=5,e.arc(game.maxXY/2,game.maxXY/2,game.maxXY/2-30,0,2*Math.PI),p.stroke(e),500<=game.maxXY){[a,b]=game.currentLevel.split("");let e=game.levels[a][b];for(i in e)[a,b,c,d]=e[i].toString().split(""),T(a,b),T(c,d)}let o;for(let t=30;t<=game.maxXY-30;t+=l){for(let e=30;e<=game.maxXY-30;e+=l)if(o=p.getImageData(t,e,1,1).data,(0<o[0]||0<o[1]||0<o[2])&&(o[0]<200||o[1]<200||o[2]<200)&&(n=!1),!n){console.log(o);break}if(!n)break}return n?(S(),!0):(alert("invalid move!"),w=[],Y(),!1)})()&&k(),game.valid=!1}};const k=()=>{[a,b]=game.currentLevel.split("");var e=game.levels[a][b];game.done.length>=e.length&&(game.levelCompleted.includes(game.currentLevel)||game.levelCompleted.push(game.currentLevel),e={levelCompleted:game.levelCompleted},localStorage.setItem("twodots",JSON.stringify(e)),alert("Well done!"),l.removeClass("d-none"),o.addClass("d-none"),m.addClass("d-none"),P(game.currentLevel.substring(0,1)))};var W=(e,t)=>{var a=E(e,t),a=a[0]+","+a[1]+","+a[2];game.waitingDraw&&"255,255,255"==a&&(game.waitingDraw=!1,game.canDraw=!0,[r,g,b]=game.currentTarget.split(","),h.strokeStyle="#"+L(parseInt(r),parseInt(g),parseInt(b)),game.startX=u=e,game.startY=v=t),game.canDraw&&(a===game.currentTarget?(20<Math.abs(game.startX-u)&&20<Math.abs(game.startY-v)&&(game.valid=!0),I()):(h.lineWidth=game.lineWidth,h.beginPath(),h.moveTo(u,v),h.lineTo(e,t),h.stroke(),u=e,v=t,w.push(u+","+v)))},y=(e,t)=>{game.waitingDraw||(t=E(e,t))[0]+t[1]+t[2]<765&&!game.done.includes(t[0]+","+t[1]+","+t[2])&&(game.waitingDraw=!0,game.currentTarget=t[0]+","+t[1]+","+t[2])};const P=t=>{var a=["BEGINNER","INTERMEDIATE","EXPERT"];if(l.html(""),1===t.length){n('<button data-level="main">Back</button>').appendTo(l);for(let e=0;e<game.levels[t].length&&(n('<button data-level="'+t+e+'">'+a[t]+" - "+(e+1)+"</button>").appendTo(l),game.levelCompleted.includes(t+""+e));e++);}else if(2===t.length)game.currentLevel=t,l.addClass("d-none"),o.removeClass("d-none"),m.removeClass("d-none"),x();else for(let e=0;e<game.levels.length;e++)n('<button data-level="'+e+'">'+a[e]+"</button>").appendTo(l)},E=(e,t)=>{t=f.getImageData(e,t,1,1).data;return[t[0],t[1],t[2]]},L=(e,t,a)=>{if(255<e||255<t||255<a)throw"Invalid color component";return("0"+e.toString(16)).slice(-2)+""+("0"+t.toString(16)).slice(-2)+("0"+a.toString(16)).slice(-2)};l.on("click","button",function(e){P(n(this).data("level").toString())}),m.on("click","#go_main",function(e){l.removeClass("d-none"),o.addClass("d-none"),m.addClass("d-none"),P("main")}).on("click","#reset",function(e){x()}),o.on("touchstart",function(e){e.target==t&&(e.preventDefault(),y(e.touches[0].clientX-o.offset().left,e.touches[0].clientY-o.offset().top))}).on("touchmove",function(e){e.touches[0].clientX-o.offset().left<0||e.touches[0].clientX>o.width()||e.touches[0].clientY<o.offset().top||e.touches[0].clientY>o.offset().top+o.height()?I():W(e.touches[0].clientX-o.offset().left,e.touches[0].clientY-o.offset().top)}).on("touchend",I).on("mousedown",function(e){e.preventDefault(),y(e.offsetX,e.offsetY)}).on("mousemove",function(e){W(e.offsetX,e.offsetY)}).on("mouseup",I).on("mouseleave",I),n(window).width()<game.maxXY&&(game.maxXY=n(window).width()),o.css({width:game.maxXY+"px",height:game.maxXY+"px"}),f.canvas.height=h.canvas.height=p.canvas.height=game.maxXY,f.canvas.width=h.canvas.width=p.canvas.width=game.maxXY,f.lineCap=h.lineCap=p.lineCap="round",f.lineWidth=h.lineWidth=p.lineWidth=game.lineWidth,X(),x()}(jQuery);